<!DOCTYPE html> 
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Heart Quest - Grammar Maze</title>

  <style>
    :root{
      /* ‚ù§Ô∏è HEART BACKGROUND */
      --bg:
        radial-gradient(circle at 20% 15%, rgba(255, 214, 225, .55) 0 18%, transparent 19% 100%),
        radial-gradient(circle at 80% 25%, rgba(255, 224, 234, .55) 0 16%, transparent 17% 100%),
        radial-gradient(circle at 30% 80%, rgba(255, 214, 225, .50) 0 18%, transparent 19% 100%),
        radial-gradient(circle at 75% 78%, rgba(255, 224, 234, .50) 0 16%, transparent 17% 100%),
        linear-gradient(180deg, #fff 0%, #fff0f6 55%, #ffe4ef 100%);

      --panel:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;

          --wall: #f9eef2;
     /* mauve walls */
      --path:#ffffff;

      --radius: 18px;
      --shadow: 0 18px 45px rgba(0,0,0,.12);

      --cell: clamp(44px, 5.4vw, 64px);
      --gap: 2px;

      --accent:#fb7185;
      --good:#22c55e;
      --bad:#ef4444;
	  --lilac: #e3d6f2;   /* –Ω–µ–∂–Ω—ã–π –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π —Å–∏—Ä–µ–Ω–µ–≤—ã–π */

    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 10px 14px 18px;
    }

    .wrap{ width:min(1100px,100%); display:flex; flex-direction:column; gap:10px; }

    .topbar{
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
	  width: fit-content;   /* üëà –≥–ª–∞–≤–Ω–æ–µ */
  margin: 0 auto;       /* üëà —Ü–µ–Ω—Ç—Ä */
    }

    .title{ display:flex; flex-direction:column; gap:2px; }
    .title strong{ font-size: 18px; }
    .title span{ font-size: 13px; color: var(--muted); font-weight: 650; }

    .hud{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 7px 12px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 900;
      background: #ffffff;
      border: 2px solid rgba(251,113,133,.55);
      box-shadow: 0 8px 18px rgba(251,113,133,.12);
    }

    .tray{ display:flex; align-items:center; gap:4px; margin-left: 4px; }
    .tray img{ width:18px; height:18px; object-fit:contain; display:block; }
    .tray .emoji{ font-size: 16px; }

    .board{
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
	  width: fit-content;     /* ‚úÖ –≥–ª–∞–≤–Ω–æ–µ */
  margin: 0 auto;         /* ‚úÖ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º */
    }

    .maze{
      position: relative;
      display:grid;
      gap: var(--gap);
      padding: var(--gap);
      border-radius: 16px;
      background: rgba(251,113,133,.35); /* –º—è–≥–∫–∏–µ —Ä–æ–∑–æ–≤—ã–µ –ª–∏–Ω–∏–∏ */
  border: 2px solid rgba(251,113,133,.45); /* —Ä–∞–º–∫–∞ */
      overflow:hidden;
      user-select:none;
    }

    .cell{ background: var(--wall); border-radius: 9px; position: relative; }
    .cell.open{ background: var(--path); border: none; }

    /* collectible hearts */
    .item{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition: transform .15s ease;
      z-index: 3;
    }
    .item:hover{ transform: scale(1.06); }
    .item img{
      width: calc(var(--cell) * .72);
      height: calc(var(--cell) * .72);
      pointer-events:none;
      display: block;
      vertical-align: middle;
    }
    .item .emoji{
      font-size: calc(var(--cell) * .62);
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.12));
    }

    /* player (cat) */
    .player{
      position: absolute;
      width: calc(var(--cell) * .78);
      height: calc(var(--cell) * .78);
      left: 0;
      top: 0;
      transform: translate(-50%, -58%);
      object-fit: contain;
      transition: left .18s linear, top .18s linear;
      z-index: 6;
      pointer-events: none;
    }

    .playerEmoji{
      position:absolute;
      transform: translate(-50%, -50%);
      left:0; top:0;
      font-size: calc(var(--cell) * .76);
      z-index: 6;
      pointer-events:none;
      filter: drop-shadow(0 4px 0 rgba(0,0,0,.14));
      transition: left .18s linear, top .18s linear;
    }

    /* finish (friend cat) */
    .finish{
      position:absolute;
      inset: 6px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 10px;
      z-index: 1;
      overflow:hidden;

      /* ‚úÖ —É–±—Ä–∞–ª–∏ —Ä–æ–∑–æ–≤—É—é –ø–æ–¥–ª–æ–∂–∫—É */
      background: transparent;
      border: none;
      pointer-events: none;
    }
    .finish img{ width:100%; height:100%; object-fit:contain; opacity:.98; display:block; }

    .shake{ animation: shake .35s ease; }
    @keyframes shake{
      0%{ transform: translate(-50%,-50%) rotate(0deg); }
      25%{ transform: translate(-50%,-50%) rotate(-6deg); }
      50%{ transform: translate(-50%,-50%) rotate(6deg); }
      75%{ transform: translate(-50%,-50%) rotate(-5deg); }
      100%{ transform: translate(-50%,-50%) rotate(0deg); }
    }

    /* QUIZ MODAL */
    .overlay{
      position:fixed; inset:0;
      background: rgba(15,23,42,.46);
      display:none; align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .overlay.show{ display:flex; }

    .modal{
      width: min(560px, 100%);
      background: var(--panel);
      border-radius: 18px;
      box-shadow: 0 24px 70px rgba(0,0,0,.26);
      padding: 16px;
      position: relative;
      z-index: 100;
      pointer-events: auto;
      border: 2px solid rgba(251,113,133,.22);
    }
    .modal h3{ margin:0 0 6px; font-size: 18px; }
    .modal p{ margin:0 0 12px; color: var(--muted); font-weight: 800; }
    .answers{ display:grid; gap: 10px; }

    .btn{
      width:100%;
      border:0;
      border-radius: 14px;
      padding: 12px 12px;
      font-weight: 950;
      font-size: 16px;
      cursor:pointer;
      background: #f1f5f9;
      color: var(--ink);
      transition: transform .08s ease, background .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.good{ background: #dcfce7; }
    .btn.bad{ background: #ffe4e6; }

    .note{ margin-top: 10px; font-weight: 950; display:none; }
    .note.good{ color: #15803d; }
    .note.bad{ color: #be123c; }

    .hearts{ display:flex; align-items:center; gap:4px; }
    .heart{ font-size: 18px; }
    .heart.off{ filter: grayscale(1) opacity(.25); }

    /* MESSAGE POPUP */
    .msgOverlay{
      position:fixed; inset:0;
      background: rgba(15,23,42,.35);
      display:none; align-items:center; justify-content:center;
      padding: 18px;
      z-index: 60;
    }
    .msgOverlay.show{ display:flex; }
    .msgModal{
      width: min(460px, 100%);
      background: var(--panel);
      border-radius: 20px;
      box-shadow: 0 26px 80px rgba(0,0,0,.28);
      padding: 16px;
      text-align:center;
      border: 2px solid rgba(251,113,133,.22);
    }
    .msgModal img{
      width: 170px;
      height: 170px;
      object-fit: contain;
      display:block;
      margin: 4px auto 10px;
      background: transparent;
    }
.finalCats{
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 18px;
  margin: 6px 0 12px;
}

.finalCats .cat{
  width: 110px;
  height: 110px;
  object-fit: contain;
}

.finalCats .cat.left{
  transform: scaleX(-1); /* —Å–º–æ—Ç—Ä–∏—Ç –≤–ø—Ä–∞–≤–æ */
}

.finalCats .cat.right{
  transform: none;       /* —Å–º–æ—Ç—Ä–∏—Ç –≤–ª–µ–≤–æ */
}

    .msgTitle{ font-size: 20px; font-weight: 1000; margin: 6px 0 6px; }
    .msgText{ color: var(--muted); font-weight: 850; margin: 0 0 12px; }
    .msgOk{
      display:inline-block;
      border:0;
      border-radius: 14px;
      padding: 10px 16px;
      font-weight: 1000;
      font-size: 16px;
      cursor:pointer;
      background: #ffe4ef;
      color: var(--ink);
      box-shadow: 0 10px 22px rgba(251,113,133,.12);
    }

    @media (max-width: 900px){
      :root{ --cell: clamp(38px, 6vw, 56px); }
    }

   /* –∫–æ—Ç–∏–∫–∏ —Å–º–æ—Ç—Ä—è—Ç –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ */
.player{ transform: translate(-50%, -58%) scaleX(-1); }  /* –≤–µ—Ä—Ö–Ω–∏–π –∫–æ—Ç ‚Äî –∑–µ—Ä–∫–∞–ª—å–Ω–æ */
.finish img{ transform: none; }                         /* –Ω–∏–∂–Ω–∏–π –∫–æ—Ç ‚Äî –∫–∞–∫ –µ—Å—Ç—å */
#scoreText{
  display: none;
}
.pill:first-child{
  display: none;
}


  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <strong>üíó Heart Quest - Grammar Maze</strong>
        <span>Click a heart ‚Üí do the tast</span>
      </div>

      <div class="hud">
        <div class="pill" title="Collected hearts">
          <span style="font-size:18px;">üíó</span>
          <span id="scoreText">0 / 16</span>
          <div class="tray" id="tray"></div>
        </div>

        <div class="pill" title="Lives">
          Lives:
          <div class="hearts">
            <span class="heart" id="h1">‚ù§Ô∏è</span>
            <span class="heart" id="h2">‚ù§Ô∏è</span>
            <span class="heart" id="h3">‚ù§Ô∏è</span>
          </div>
        </div>
      </div>
    </div>

    <div class="board">
      <div class="maze" id="maze"></div>
    </div>
  </div>

  <!-- QUIZ MODAL -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3>Choose the correct answer:</h3>
      <p id="qText"></p>
      <div class="answers" id="answers"></div>
      <div class="note" id="note"></div>
    </div>
  </div>

  <!-- MESSAGE POPUP -->
  <div class="msgOverlay" id="msgOverlay">
  <div class="msgModal">

  <!-- –û–î–ù–ê –ö–ê–†–¢–ò–ù–ö–ê (–¥–ª—è Try again) -->
  <img id="msgImg" src="" alt="message" onerror="this.style.display='none'">

  <!-- –î–í–ê –ö–û–¢–ê (–¥–ª—è –ø–æ–±–µ–¥—ã) -->
  <div class="finalCats" id="finalCats" style="display:none">
    <img src="cat_player.jpg" class="cat left" alt="cat">
    <img src="cat_friend.png" class="cat right" alt="cat">
  </div>

  <div class="msgTitle" id="msgTitle">Great job!</div>
  <div class="msgText" id="msgText">You did it!</div>
  <button class="msgOk" id="msgOk">OK</button>
</div>



  </div>

<script>
/* =========================
   MAP
   ========================= */
const mazeMap = [
  [1,1,1,0,1,1,1,1,1,1,1,1],
  [0,0,1,0,1,0,0,0,0,1,0,1],
  [1,1,1,1,1,1,1,1,0,1,1,1],
  [1,0,0,0,0,0,1,1,0,1,0,1],
  [1,1,1,1,1,0,1,0,0,1,0,1],
  [0,0,0,0,1,0,1,1,1,1,1,1],
  [1,1,1,0,1,1,1,0,0,1,0,1],
  [1,0,1,1,1,0,1,1,1,1,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1],
];

const W = mazeMap[0].length;
const H = mazeMap.length;

const startPos = { c: 0, r: 0 };
const exitPos  = { c: W - 1, r: H - 1 };

/* =========================
   QUIZZES (3rd grade): to be / have(has) got / can(can't)
   mix: affirmative, negative, questions
   ========================= */
const BASE_QUIZZES = [
  // TO BE
  { q: "I ___ seven today.", options: ["am","is"], correctIndex: 0 },
  { q: "He ___ my friend.", options: ["is","are"], correctIndex: 0 },
  { q: "They ___ in the garden.", options: ["are","am"], correctIndex: 0 },
  { q: "Mum ___ not at home.", options: ["is","are"], correctIndex: 0 },
  { q: "We ___ a happy family.", options: ["are","is"], correctIndex: 0 },
  { q: "___ you eight?", options: ["Are","Is"], correctIndex: 0 },

 
  { q: "This ___ my red bike.", options: ["is","are"], correctIndex: 0 },
  { q: "It ___  a big dog.", options: ["is","are"], correctIndex: 0 },
  { q: "She ___ not his sister.", options: ["is","are"], correctIndex: 0 },
  { q: "They ___ in the living room. ", options: ["are","is"], correctIndex: 0 },
  { q: "The car ___ black. ", options: ["are","is"], correctIndex: 1 },
  { q: "___ she your grandma?", options: ["Are","Is"], correctIndex: 1 },

  
  { q: "What ___ your name? ", options: ["are","is"], correctIndex: 1 },
  { q: "Where ___ Ann and Pam? ", options: ["are","is"], correctIndex: 0 },
  { q: "How old ___ your brother?", options: ["are","is"], correctIndex: 1 },
  { q: "___ you in the bedroom?", options: ["Is","Are"], correctIndex: 1 },
];

const itemsPositions = [
  { id:"h1",  c:2,  r:0 },
  { id:"h2",  c:10, r:0 },
  { id:"h3",  c:4,  r:1 },
  { id:"h4",  c:2,  r:2 },
  { id:"h5",  c:6,  r:2 },
  { id:"h6",  c:10, r:2 },
  { id:"h7",  c:6,  r:3 },
  { id:"h8",  c:4,  r:4 },
  { id:"h9",  c:8,  r:5 },
  { id:"h10", c:0,  r:2 },
  { id:"h11", c:2,  r:6 },
  { id:"h12", c:1,  r:8 },
  { id:"h13", c:9,  r:7 },
  { id:"h14", c:11, r:6 },
  { id:"h15", c:5,  r:6 },
  { id:"h16", c:6,  r:8 },
];

const TOTAL = BASE_QUIZZES.length;

/* =========================
   ASSETS (rename files as you like)
   ========================= */
const IMG_PLAYER = "cat_player.jpg";
const IMG_FRIEND = "cat_friend.png";
const IMG_HEART  = "heart.png";
const IMG_SAD = "sad.png";


/* =========================
   DOM
   ========================= */
const mazeEl = document.getElementById('maze');
const overlay = document.getElementById('overlay');
const qText = document.getElementById('qText');
const answersEl = document.getElementById('answers');
const noteEl = document.getElementById('note');
const trayEl = document.getElementById('tray');
const scoreText = document.getElementById('scoreText');

const msgOverlay = document.getElementById('msgOverlay');
const msgImg = document.getElementById('msgImg');
const msgTitle = document.getElementById('msgTitle');
const msgText = document.getElementById('msgText');
const msgOk = document.getElementById('msgOk');

/* =========================
   STATE
   ========================= */
let quizPool = [];
let lives = 3;
let score = 0;
let collected = new Set();
let playerPos = { ...startPos };
let pending = null;
let gameFinished = false;
let msgAction = null;

function cellIndex(c,r){ return r * W + c; }
function isOpen(c,r){ return r>=0 && r<H && c>=0 && c<W && mazeMap[r][c] === 1; }
function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

function cellCenterPx(c,r){
  const cell = mazeEl.children[cellIndex(c,r)];
  const rect = cell.getBoundingClientRect();
  const mazeRect = mazeEl.getBoundingClientByIdRect ? mazeEl.getBoundingClientByIdRect() : mazeEl.getBoundingClientRect();
  return {
    x: (rect.left - mazeRect.left) + rect.width/2,
    y: (rect.top  - mazeRect.top ) + rect.height/2
  };
}

function bfsPath(from, to){
  if(!isOpen(to.c,to.r)) return null;

  const q = [];
  const prev = Array(H).fill(null).map(()=>Array(W).fill(null));
  const seen = Array(H).fill(null).map(()=>Array(W).fill(false));

  q.push(from);
  seen[from.r][from.c] = true;

  const dirs = [{dc:1,dr:0},{dc:-1,dr:0},{dc:0,dr:1},{dc:0,dr:-1}];

  while(q.length){
    const cur = q.shift();
    if(cur.c === to.c && cur.r === to.r) break;

    for(const d of dirs){
      const nc = cur.c + d.dc;
      const nr = cur.r + d.dr;
      if(!isOpen(nc,nr)) continue;
      if(seen[nr][nc]) continue;
      seen[nr][nc] = true;
      prev[nr][nc] = cur;
      q.push({c:nc, r:nr});
    }
  }

  if(!seen[to.r][to.c]) return null;

  const path = [];
  let cur = to;
  while(cur){
    path.push(cur);
    cur = prev[cur.r][cur.c];
  }
  path.reverse();
  return path;
}

function showMessage({title, text, imgSrc=null, mode="single", action=null}){
  msgAction = action;
  msgTitle.textContent = title;
  msgText.textContent = text;

  const finalCats = document.getElementById('finalCats');

  if(mode === "final"){
    if(finalCats) finalCats.style.display = 'flex';
    if(msgImg) msgImg.style.display = 'none';
  } else {
    if(finalCats) finalCats.style.display = 'none';
    if(msgImg){
      if(imgSrc){
        msgImg.style.display = '';
        msgImg.src = imgSrc;
      } else {
        msgImg.style.display = 'none';
      }
    }
  }

  msgOverlay.classList.add('show');
}

function closeMessage(){ msgOverlay.classList.remove('show'); }

function getPlayerEl(){
  return document.getElementById('playerImg') || document.getElementById('playerEmoji');
}

function placePlayerInstant(c,r){
  const el = getPlayerEl();
  const p = cellCenterPx(c,r);
  el.style.left = p.x + 'px';
  el.style.top  = p.y + 'px';
}

async function movePlayerAlong(path){
  const el = getPlayerEl();
  for(let i=1; i<path.length; i++){
    playerPos = { c: path[i].c, r: path[i].r };
    const p = cellCenterPx(playerPos.c, playerPos.r);
    el.style.left = p.x + 'px';
    el.style.top  = p.y + 'px';
    await sleep(140);
  }
}

function removeFinishMarker(){
  const fin = document.querySelector('.finish');
  if(fin) fin.remove();
}

function renderFinishMarker(){
  if(!isOpen(exitPos.c, exitPos.r)) return;

  const cell = mazeEl.children[cellIndex(exitPos.c, exitPos.r)];
  if(!cell) return;
  if(cell.querySelector('.finish')) return;

  const fin = document.createElement('div');
  fin.className = 'finish';
  fin.innerHTML = `
    <img id="finishImg" src="${IMG_FRIEND}" alt="friend"
      onerror="this.outerHTML='üò∫'">
  `;
  cell.appendChild(fin);
}

function renderMaze(){
  mazeEl.style.gridTemplateColumns = `repeat(${W}, var(--cell))`;
  mazeEl.style.gridTemplateRows    = `repeat(${H}, var(--cell))`;
  mazeEl.innerHTML = '';

  for(let r=0; r<H; r++){
    for(let c=0; c<W; c++){
      const div = document.createElement('div');
      div.className = 'cell' + (mazeMap[r][c]===1 ? ' open' : '');
      mazeEl.appendChild(div);
    }
  }

  renderFinishMarker();

  for(const p of itemsPositions){
    if(!isOpen(p.c,p.r)) continue;
    if(p.c === startPos.c && p.r === startPos.r) continue;
    if(p.c === exitPos.c && p.r === exitPos.r) continue;

    const cell = mazeEl.children[cellIndex(p.c,p.r)];
    const item = document.createElement('div');
    item.className = 'item';
    item.dataset.id = p.id;

    item.innerHTML = `
      <img src="${IMG_HEART}" alt="heart"
        onerror="this.remove(); this.parentElement.insertAdjacentHTML('beforeend','<span class=\\'emoji\\'>üíó</span>')">
    `;

    item.addEventListener('click', () => onItemClick(p.id));
    cell.appendChild(item);
  }

  const playerImg = document.createElement('img');
  playerImg.src = IMG_PLAYER;
  playerImg.alt = 'cat';
  playerImg.className = 'player';
  playerImg.id = 'playerImg';
  playerImg.onerror = () => {
    playerImg.remove();
    const h = document.createElement('div');
    h.id = 'playerEmoji';
    h.className = 'playerEmoji';
    h.textContent = 'üê±';
    mazeEl.appendChild(h);
    placePlayerInstant(playerPos.c, playerPos.r);
  };
  mazeEl.appendChild(playerImg);

  placePlayerInstant(playerPos.c, playerPos.r);
}

function updateHUD(){
  scoreText.textContent = `${score} / ${TOTAL}`;
  document.getElementById('h1').classList.toggle('off', lives < 1);
  document.getElementById('h2').classList.toggle('off', lives < 2);
  document.getElementById('h3').classList.toggle('off', lives < 3);
}

function getRandomQuizPick(){
  if(quizPool.length === 0) return null;
  const idx = Math.floor(Math.random() * quizPool.length);
  return { quiz: quizPool[idx], idx };
}

function openQuiz(quiz){
  qText.textContent = quiz.q;

  answersEl.innerHTML = '';
  noteEl.style.display = 'none';
  noteEl.className = 'note';

  quiz.options.forEach((opt, idx) => {
    const b = document.createElement('button');
    b.className = 'btn';
    b.textContent = opt;
    b.addEventListener('click', () => submitAnswer(idx));
    answersEl.appendChild(b);
  });

  overlay.classList.add('show');
}
function closeQuiz(){ overlay.classList.remove('show'); }

function onItemClick(itemId){
  if(gameFinished) return;
  if(collected.has(itemId)) return;

  const pos = itemsPositions.find(x => x.id === itemId);
  if(!pos) return;

  const path = bfsPath(playerPos, {c:pos.c, r:pos.r});
  if(!path){
    const el = getPlayerEl();
    el.classList.add('shake');
    setTimeout(()=>el.classList.remove('shake'), 380);
    return;
  }

  const pick = getRandomQuizPick();
  if(!pick) return;

  pending = { itemId, path, quiz: pick.quiz, quizIdx: pick.idx };
  openQuiz(pick.quiz);
}

async function submitAnswer(chosenIndex){
  if(!pending) return;

  const isCorrect = chosenIndex === pending.quiz.correctIndex;

  [...answersEl.children].forEach((btn, idx) => {
    btn.disabled = true;
    btn.classList.remove('good','bad');
    if(idx === pending.quiz.correctIndex) btn.classList.add('good');
    if(idx === chosenIndex && !isCorrect) btn.classList.add('bad');
  });

  noteEl.style.display = 'block';

  if(isCorrect){
    noteEl.className = 'note good';
    noteEl.textContent = "Correct!";
    await sleep(320);
    closeQuiz();

    quizPool.splice(pending.quizIdx, 1);

    collected.add(pending.itemId);
    const itemEl = mazeEl.querySelector(`.item[data-id="${pending.itemId}"]`);
    if(itemEl) itemEl.remove();

    const img = document.createElement('img');
    img.src = IMG_HEART;
    img.alt = 'heart';
    img.onerror = () => {
      img.remove();
      const s = document.createElement('span');
      s.className = 'emoji';
      s.textContent = 'üíó';
      trayEl.appendChild(s);
    };
    trayEl.appendChild(img);

    score++;
    updateHUD();

    await movePlayerAlong(pending.path);

    if(score >= TOTAL){
      gameFinished = true;

      const toExit = bfsPath(playerPos, exitPos);
      if(toExit) await movePlayerAlong(toExit);

      await sleep(200);

      showMessage({
  title: "Great job! üíó",
  text: "You collected all hearts and reached your friend!",
  mode: "final",
  action: null
});

    }

    pending = null;
    return;
  }

  noteEl.style.display = 'none';
  noteEl.textContent = '';

  lives--;
  updateHUD();

  const el = getPlayerEl();
  el.classList.add('shake');
  setTimeout(()=>el.classList.remove('shake'), 380);

  await sleep(520);

  if(lives <= 0){
    closeQuiz();
    showMessage({
      title: "Oh, no!",
      text: "Try again!",
      imgSrc: IMG_SAD,
      action: "restart"
    });
    pending = null;
    return;
  }

  [...answersEl.children].forEach(btn => btn.disabled = false);
  noteEl.style.display = 'none';
}

function initGame(){
  quizPool = BASE_QUIZZES.map(q => ({...q, options:[...q.options]}));
  lives = 3;
  score = 0;
  collected = new Set();
  playerPos = { ...startPos };
  pending = null;
  gameFinished = false;

  trayEl.innerHTML = '';
  renderMaze();
  updateHUD();
}

overlay.addEventListener('click', (e) => { if(e.target === overlay) closeQuiz(); });
document.querySelector('#overlay .modal')
  .addEventListener('click', (e) => e.stopPropagation());

msgOk.addEventListener('click', () => {
  const action = msgAction;
  closeMessage();
  msgAction = null;
  if(action === "restart"){
    initGame();
  }
});
msgOverlay.addEventListener('click', (e) => { if(e.target === msgOverlay) msgOk.click(); });

initGame();
</script>
</body>
</html>
